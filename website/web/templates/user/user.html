{% extends "main.html" %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/lodash.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
{% endblock %}
{% block title %}User: {{ user.login }}{% endblock %}
{% block content %}
<div class="row">
  <div class="col">
    <h1>~/{{ user.login }}</h1>
  </div>
    <div class="col text-end">
      <a class="icon-link" href="{{ url_for('user_bp.feed_activity', login=user.login, format='atom') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
      <a class="icon-link" href="{{ url_for('user_bp.feed_activity', login=user.login, format='rss') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
    </div>
</div>
<div class="row">
    <div class="col">
       <p>{{ user.name }} has been a member since {{ user.created_at | datetimeformat('%c') }}
        and was last connected on {{ user.last_seen | datetimeformat('%c') }}.</p>
   </div>
</div>
{% if user.organisation %}
<div class="row">
    <div class="col">
       <p>This user is a member of {{ user.organisation }}.</p>
   </div>
</div>
{% endif %}
<div class="row">
  <div class="col">
    <div class="row">
      <div class="col">
        <h3>Recent comments</h3>
      </div>
        <div class="col text-end">
          <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', user=user.login, format='atom') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
          <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', user=user.login, format='rss') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
        </div>
    </div>
    <div id="list-comments">
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
        </div>
    </div>
    <p><a href="{{ url_for('comments_bp.list_comments') }}">All comments</a>.</p>
  </div>
  <div class="col">
    <div class="row">
      <div class="col">
        <h3>Recent bundles</h3>
      </div>
        <div class="col text-end">
          <a class="icon-link" href="{{ url_for('bundles_bp.feed_bundles', user=user.login, format='atom') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
          <a class="icon-link" href="{{ url_for('bundles_bp.feed_bundles', user=user.login, format='rss') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
        </div>
    </div>
    <div id="list-bundles">
      <div class="d-flex justify-content-center">
          <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
      </div>
    </div>
    <p><a href="{{ url_for('bundles_bp.list_bundles') }}">All bundles</a>.</p>
  </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var converter = new showdown.Converter()
        var commentTemplate = _.template(
        '<div class="card">' +
        '<div class="card-body">' +
        '<h5 class="card-title"><%= title %> on <%= vulnerability_id %></h5>' +
        '<h6 class="card-subtitle mb-2 text-body-secondary"><%= timestamp %></h6>' +
        '<p class="card-text"><%= description %></p>' +
        '<p class="card-text">More details about <a href="/vuln/<%= vulnerability_id %>"><%= vulnerability_id %></a>.</p>' +
        '<% _.forEach(related_vulnerabilities, function(vuln) ' +
            '{ %><a href="/vuln/<%= vuln %>"><%- vuln %></a> <% }); %>',
        '</div>');
        fetch("{{ url_for('apiv1.comment_comments_list', author=user.login) }}")
        .then(response => response.json())
        .then(result => {
        document.getElementById("list-comments").innerHTML = "";
        if (result.metadata.count == 0) {
            document.getElementById("list-comments").innerHTML = "<p>No comment.</p>";
        }
        result.data
        .sort(function (a, b) {
            return new Date(b.updated_at) - new Date(a.updated_at);
        })
        .map(function (comment) {
            var cardHTML = commentTemplate({
            'id': comment.id,
            'title': comment.title,
            'description': converter.makeHtml(comment.description),
            'timestamp': moment(comment.timestamp).fromNow(),
            'vulnerability_id': comment.vulnerability,
            'related_vulnerabilities': comment.related_vulnerabilities,
            });
            var element = document.createElement("div");
            var element_br = document.createElement("br");
            element.innerHTML = cardHTML;
            document.getElementById("list-comments").appendChild(element.firstChild);
            document.getElementById("list-comments").append(element_br);
        })
        })
        .catch((error) => {
        console.error('Error:', error);
        });


        var converter = new showdown.Converter()
        var bundleTemplate = _.template(
            '<div class="card">' +
            '<div class="card-body">' +
            '<h5 class="card-title"><a href="/bundle/<%= uuid %>"><%= name %></a></h5>' +
            '<h6 class="card-subtitle mb-2 text-body-secondary"><%= timestamp %> by <a href="/user/<%= author_login %>"><%= author_name %></a></h6>' +
            '<p class="card-text"><%= description %></p>' +
            'Related vulnerabilities: <% _.forEach(related_vulnerabilities, function(vuln) ' +
                '{ %><a href="/vuln/<%= vuln %>"><%- vuln %></a> <% }); %><br />' +
            '</div>');
        fetch("{{ url_for('apiv1.bundle_bundles_list', author=user.login) }}")
        .then(response => response.json())
        .then(result => {
        document.getElementById("list-bundles").innerHTML = "";
        if (result.metadata.count == 0) {
            document.getElementById("list-bundles").innerHTML = "<p>No bundle.</p>";
        }
        result.data
        .sort(function (a, b) {
            return new Date(b.updated_at) - new Date(a.updated_at);
        })
        .map(function (bundle) {
            var author = bundle.author
            delete bundle.author;
            var cardHTML = bundleTemplate({
            'uuid': bundle.uuid,
            'name': bundle.name,
            'description': converter.makeHtml(bundle.description),
            'timestamp': moment(bundle.timestamp).fromNow(),
            'related_vulnerabilities': bundle.related_vulnerabilities,
            'author_name': author.name,
            'author_login': author.login
            });
            var element = document.createElement("div");
            var element_br = document.createElement("br");
            element.innerHTML = cardHTML;
            document.getElementById("list-bundles").appendChild(element.firstChild);
            document.getElementById("list-bundles").append(element_br);
        })
        })
        .catch((error) => {
        console.error('Error:', error);
        });
    });
</script>
{% endblock %}

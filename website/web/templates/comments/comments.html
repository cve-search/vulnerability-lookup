{% extends "main.html" %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/lodash.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/luxon.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/pretty-print-json.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/pretty-print-json.css') }}" />
{% endblock %}
{% block title %}Comments{% endblock %}
{% block content %}
<h1>Recent comments</h1>
<div class="row text-right">
    <div class="col">
      {% if not current_user.is_authenticated %}
        <p><a href="{{ url_for('user_bp.login') }}">Log in</a> or <a href="{{ url_for('user_bp.signup') }}">create an account</a> to share your comment.</p>
      {% endif %}
      <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
        <input type="radio" class="btn-check" name="btnradio" id="comments-all" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="comments-all" title="All kind of comments.">All</label>

        <input type="radio" class="btn-check" name="btnradio" id="comments-poc" autocomplete="off">
        <label class="btn btn-outline-primary" for="comments-poc" title="Comments related to a Proof of Concept.">PoC</label>
      </div>
      <span id="badge-filter"><h3></h3></span>
    </div>
    <div class="col text-end">
        <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', format='atom') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
        <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', format='rss') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
    </div>
</div>
<br />
<div id="list-comments">
    <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
    </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const urlObj = new URL(window.location.href);
    const params = new URLSearchParams(urlObj.search);
    const meta = params.get('meta');
    if (meta !== null) {
      load_comments("meta="+meta);
      if (meta.includes("information=PoC")) {
        var elem = document.getElementById("comments-poc");
        elem.checked = true;
      } else {
        const badge = document.createElement('span');
        badge.id = "meta-filter";
        badge.classList.add('badge', 'bg-primary');
        badge.innerHTML = decodeURIComponent(meta);
        document.getElementById("badge-filter").appendChild(badge);
      }
    } else {
      load_comments();
    }
  });

  document.getElementById("comments-all").onclick = function(event) {
    const parent = document.getElementById('badge-filter');
    const child = document.getElementById('meta-filter');
    if (child && parent.contains(child)) {
      parent.removeChild(child);
    }
    load_comments("");
  };

  document.getElementById("comments-poc").onclick = function(event) {
    const parent = document.getElementById('badge-filter');
    const child = document.getElementById('meta-filter');
    if (child && parent.contains(child)) {
      parent.removeChild(child);
    }
    load_comments("meta=%5B%7B%22tags%22%3A%20%5B%22vulnerability:information=PoC%22%5D%7D%5D");
  };

  function load_comments(parameters){
    var DateTime = luxon.DateTime;
    var converter = new showdown.Converter({tables: true});
    var commentTemplate = _.template(
    '<div class="card markdown-description">' +
    '<div class="card-body">' +
    '<h5 class="card-title"><a href="/comment/<%= uuid %>"><%= title %></a> on <%= vulnerability_id %></h5>' +
    '<h6 class="card-subtitle mb-2 text-body-secondary"><%= timestamp %> by <a href="/user/<%= author_login %>"><%= author_name %></a></h6>' +
    '<p class="card-text"><%= description %></p>' +
    '<a role="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#collapseJsonComment<%= uuid %>" aria-expanded="false" aria-controls="collapseJsonComment<%= uuid %>">JSON</a>' +
    '<div class="collapse" id="collapseJsonComment<%= uuid %>"><br /><pre class="json-container"><%= comment %></pre></div><hr />' +
    '<a class="btn btn-primary" href="/vuln/<%= vulnerability_id %>"><%= vulnerability_id %></a>' +
    '</div>');
    url = "{{ url_for('apiv1.comment_comments_list') }}"
    if (url != "") {
      url = url + "?" + parameters;
    }
    fetch(url)
    .then(response => response.json())
    .then(result => {
      document.getElementById("list-comments").innerHTML = "";
      if (result.metadata.count == 0) {
          document.getElementById("list-comments").innerHTML = "<p>No comment.</p>";
      }
      result.data
      .sort(function (a, b) {
          return new Date(b.updated_at) - new Date(a.updated_at);
      })
      .map(function (comment) {
        var author = comment.author
        delete comment.author;

        var description = converter.makeHtml(comment.description);
        description = linkifyCVE(description);
        description = linkifyGHSA(description);

        var cardHTML = commentTemplate({
        'comment': prettyPrintJson.toHtml(JSON.parse(JSON.stringify(comment, null, 2))),
        'uuid': comment.uuid,
        'title': comment.title,
        'description': description,
        'timestamp': DateTime.fromISO(comment.timestamp).toRelative(),
        'vulnerability_id': comment.vulnerability.toLowerCase(),
        'author_name': author.name,
        'author_login': author.login,
        });
        var element = document.createElement("div");
        var element_br = document.createElement("br");
        element.innerHTML = cardHTML;
        document.getElementById("list-comments").appendChild(element.firstChild);
        document.getElementById("list-comments").append(element_br);
      })
    })
    .then(_ => {
      setTimeout(() => {
        formatMarkdownOutput();
      }, 0);  // 0ms delay still allows the browser to update the DOM
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  }
</script>
{% endblock %}

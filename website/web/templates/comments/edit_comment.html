{% extends "main.html" %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/jsoneditor.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/pretty-print-json.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/easymde.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/easymde.min.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/pretty-print-json.css') }}" />
{% endblock %}
{% block title %}{{ action }}{% endblock %}
{% block content %}
<div class="modal" id="modalError" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modal-title" class="modal-title">Action not permitted</h5>
      </div>
      <div class="modal-body">
        <p id="modal-error-text">Modal body text goes here.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col">
    <h2>{{ action | safe }}</h2>
  </div>
  <div class="col text-end">
    <div class="btn-group" role="group">
      <a type="button" id="savecomment" class="btn btn-primary" title="Save" aria-label="Save">Save</a>
      <a type="button" class="btn btn-primary" title="View" aria-label="View" href="{{ url_for('comment_bp.get', comment_uuid=comment.uuid) }}">View</a>
      <a role="button" class="btn btn-danger" title="Delete" aria-label="Delete" href="{{ url_for('comment_bp.delete_comment', comment_uuid=comment.uuid) }}" onclick="return confirm('You are going to delete this comment.');">Delete</a>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-9">
    <div id='editor'></div>
  </div>
  <div class="col">
    <br /><br /><br />
    <div class="card card-body my-3 bg-light">
      <h5>Tags</h5>
      <select class="form-multi-select" id="select-tags" size="9" multiple>
        <optgroup label="Exploitability" exclusive="true">
          <option value="vulnerability:exploitability=industrialised">Industrialised</option>
          <option value="vulnerability:exploitability=customised">Customised</option>
          <option value="vulnerability:exploitability=documented">Documented</option>
          <option value="vulnerability:exploitability=theoretical">Theoretical</option>
        </optgroup>
        <optgroup label="Information" exclusive="false">
          <option value="vulnerability:information=PoC">Proof-of-Concept</option>
          <option value="vulnerability:information=remediation">Remediation</option>
          <option value="vulnerability:information=annotation">Annotation</option>
        </optgroup>
      </select>
      <a href="https://www.misp-project.org/taxonomies.html#_vulnerability_3" rel="noreferrer" target="_blank">Taxonomy of the tags.</a>
    </div>
  </div>
</div>


<br />
<script>
  function getSelectValues(select) {
    var tags = [];
    var options = select && select.options;
    var opt;

    for (var i=0, iLen=options.length; i<iLen; i++) {
      opt = options[i];

      if (opt.selected) {
        if (opt.parentNode.getAttribute("exclusive") == "true") {
          options1 = document.getElementById("select-tags").options;
          for (var j=0, jLen=options1.length; j<jLen; j++) {
            opt1 = options1[j];
            if (opt1.parentNode.getAttribute("exclusive") == "true") {
              opt1.selected = false;
            }
          }
          opt.selected = true;
        }
        tags.push(opt.value || opt.text);
      }
    }
    var json = jsoneditor.getValue();

    json["meta"].forEach(function(value, index, array) {
      if ("tags" in value) {
        obj = {"tags": tags}
        json["meta"] = [];
        json["meta"] = [obj];
      }
    })

    jsoneditor.setValue(json);
  }

  document.getElementById("select-tags").onclick= function (e) {
    getSelectValues(document.getElementById("select-tags"));
  };


  let easyMDE = null;
  document.addEventListener("DOMContentLoaded", function() {
    // Retrieve the comment
    fetch("{{ url_for('apiv1.comment_comment_item', comment_uuid=comment.uuid) }}")
    .then(response => response.json())
    .then(comment => {

      // initialize the multi-selct component with tags from the comment
      var element = document.getElementById('select-tags');
      comment["meta"].forEach(function(value, index, array) {
        if ("tags" in value) {
          values = value["tags"];
          for (var i = 0; i < element.options.length; i++) {
            element.options[i].selected = values.indexOf(element.options[i].value) >= 0;
          }
        }
      })

      // Retrieve the schema for the comment
      fetch("{{ url_for('static', filename='schemas/CIRCL/Security_Advisory_Comment.json') }}")
      .then(response => response.json())
      .then(schema => {
        // Initialize the JSON editor
        initialize_editor(schema, comment);
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  });

  function initialize_editor(schema, json_object) {
    // Default starting schema
    if(!schema) {
      schema = {}
    }

    // Divs/textareas on the page
    var $schema = schema;
    var $output = document.getElementById('output');
    var $editor = document.getElementById('editor');

    // Default theme
    JSONEditor.defaults.options.theme = 'bootstrap5';

    window.startval = json_object;

    var jsoneditor;

    var reload = function(keep_value) {
      var startval = (jsoneditor && keep_value)? jsoneditor.getValue() : window.startval;
      window.startval = undefined;

      if (jsoneditor) {
        jsoneditor.destroy();
      }
      jsoneditor = new JSONEditor($editor, {
        // The schema for the editor
        schema: schema,
        // Remove collapse button
        disable_collapse: true,
        // Seed the form with a starting value
        startval: startval,
        // Enable fetching schemas via ajax
        ajax: true,
        // Disable additional properties
        no_additional_properties: false,
        // Require all properties by default
        required_by_default: true,
        show_opt_in: false,
        disable_edit_json: true,
        theme: "bootstrap5",
      });
      window.jsoneditor = jsoneditor;

      // When the value of the editor changes, update the JSON output and validation message
      jsoneditor.on('change',function() {
        var json = jsoneditor.getValue();
      });

      jsoneditor.on('ready', async () => {
        if (easyMDE  === null) {
          easyMDE = new EasyMDE({
            element: document.getElementById('root[description]'),
            autoRefresh: { delay: 300 }
          });
        }
      });
    };

    // Start the schema and output textareas with initial values
    $schema.value = JSON.stringify(schema, null, 2);
    reload();
  };


  document.getElementById("savecomment").onclick = function(event) {
    var csrf_token = "{{ csrf_token() }}";
    var json = jsoneditor.getValue();
    json["description"] = easyMDE.value();
    data = JSON.stringify(json);
    fetch("{{ url_for('apiv1.comment_comments_list') }}", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrf_token
      },
      body: data
    })
    .then(res => {
      if (!res.ok) {
        res.json().then(json => {
          document.getElementById("modal-error-text").innerText = json['message'];
          document.getElementById("modal-title").innerText = "Error";
          var modal = new bootstrap.Modal(document.getElementById('modalError'), {});
          modal.show();
        });
      } else {
        // reinitializes the form
        // window.jsoneditor.setValue({});
        // easyMDE.value("");
        document.getElementById("modal-error-text").innerText = "Comment successfully saved.";
        document.getElementById("modal-title").innerText = "Success";
        var modal = new bootstrap.Modal(document.getElementById('modalError'), {});
        modal.show();
      }
    })
    .catch((error) => {
      console.log(error);
    });
  };

</script>
{% endblock %}
